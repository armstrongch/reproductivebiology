<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Reproductive Biology</title>
		<style type="text/css">
			#gameCanvas {
				outline: solid 1px black;
			}
			#infoDiv {
				outline: solid 1px black;
				height: 480px;
				width: 640px;
				text-align: center;
			}
			#buttonDiv {
				text-align: center;
				width: 640px;
				margin: 10px;
			}
			#previousButton, nextButton {
				display: inline-block;
			}
		</style>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, width=device-width, user-scalable=no" />
	</head>
	<body onload="loadPage()">
		<div id="infoDiv">
			<h1 id="header"></h1>
			<h2 id="description"><h2>
			<h2 id="instructions"><h2>
			<h2>Press Space to Begin!</h2>
		</div>
		<canvas id="gameCanvas" width="0" height="0"></canvas>
		<div id="buttonDiv">
			<button id="previousButton" onclick="previousTask()"><h3>Previous Task</h3></button>
			<button id="nextButton" onclick="nextTask()"><h3>Next Task</h3></button>
		</div>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script>
		<script type="text/javascript">
		
			var gameCanvas = document.getElementById("gameCanvas");
			var ctx = gameCanvas.getContext("2d");
			
			var mode = "info";
			var taskIndex = 0;
			var gameInterval;
			
			var tasks = 
			[
				{
					header: "Find the Fallopian Tube",
					description: "Educational description goes here.",
					instructions: "Tap the space bar to hop all the way to the fallopian tube!"
				},
				{
					header: "Collect Calcium",
					description: "Educational description goes here.",
					instructions: "Tap the space bar to collect calcium on the way to the egg!"
				},
				{
					header: "ZP3 Binding",
					description: "Educational description goes here.",
					instructions: "Tap the space bar at the perfect moment to bind to ZP3."
				}
			];
			
			var gameLoops =
			[
				taskOne,
				taskTwo,
				taskThree
			];
			
			var taskSetUp = [];
			
			function showInfo()
			{
				$(gameCanvas).css('display', 'none');
				$('#infoDiv').css('display', 'block');
				
				var task = tasks[taskIndex];
				$('#header').html(task.header);
				$('#description').html(task.description);
				$('#instructions').html(task.instructions);
				
				mode = "info";
				setupButtons();
				clearInterval(gameInterval);
			}
			
			function showGame()
			{
				$(gameCanvas).css('display', 'block');
				$('#infoDiv').css('display', 'none');
				
				mode = "game";
				resetTasks();
				clearInterval(gameInterval);
				gameInterval = setInterval(gameLoops[taskIndex], 35); //Approx 30 frames per second
			}
			
			function resetTasks()
			{
				for (let i = 0; i < taskSetUp.length; i++)
				{
					taskSetUp[i] = false;
				}
			}
			
			function completeTask()
			{
				clearInterval(gameInterval);
			}
			
			function loadPage()
			{
				gameCanvas.width = 640;
				gameCanvas.height = 480;
				
				for (let i = 0; i < tasks.length; i++)
				{
					taskSetUp.push(false);
				}
				
				document.addEventListener('keydown', (e) => 
					{
						if (e.code === "ArrowUp")
						{
							arrowPressed("Up");
						}
						else if (e.code === "ArrowDown")
						{
							arrowPressed("Down");
						}
						else if (e.code === "ArrowLeft")
						{
							arrowPressed("Left");
						}
						else if (e.code === "ArrowRight")
						{
							arrowPressed("Right");
						}
						else if (e.code === "Space") //A
						{
							spacePressed();
						}
					}
				);
				
				document.addEventListener('keyup', (e) => 
					{
						if (e.code === "ArrowUp")
						{
							arrowReleased("Up");
						}
						else if (e.code === "ArrowDown")
						{
							arrowReleased("Down");
						}
						else if (e.code === "ArrowLeft")
						{
							arrowReleased("Left");
						}
						else if (e.code === "ArrowRight")
						{
							arrowReleased("Right");
						}
						else if (e.code === "Space") //A
						{
							spaceReleased();
						}
					}
				);
				
				taskIndex = 0;
				showInfo();
			}
			
			function setupButtons()
			{
				$('#nextButton').css('min-width', $('#previousButton').css('width'));
				$('#previousButton').prop('disabled', taskIndex == 0);
				$('#nextButton').prop('disabled', taskIndex == tasks.length - 1);
			}
			
			function previousTask()
			{
				if (taskIndex > 0)
				{
					taskIndex--;
					showInfo();
					$('#previousButton').blur();
				}
			}
			
			function nextTask()
			{
				if (taskIndex < tasks.length - 1)
				{
					taskIndex++;
					showInfo();
					$('#infoDiv').focus();
					$('#nextButton').blur();
				}
			}
			
			var up = false;
			var down = false;
			var left = false;
			var right = false;
			var space = false;
			
			function arrowPressed(direction)
			{
				console.log("Pressed " + direction + "!");
				switch (direction)
				{
					case "Up":
						up = true;
						break;
					case "Down":
						down = true;
						break;
					case "Left":
						left = true;
						break;
					case "Right":
						right = true;
						break;
				}
			}
			
			function arrowReleased(direction)
			{
				console.log("Released " + direction + "!");
				switch (direction)
				{
					case "Up":
						up = false;
						break;
					case "Down":
						down = false;
						break;
					case "Left":
						left = false;
						break;
					case "Right":
						right = false;
						break;
				}
			}
			
			function spacePressed()
			{
				if (mode == "info")
				{
					showGame(taskIndex);
				}
				else
				{
					console.log("Pressed Space!");
					space = true;
				}
			}
			
			function spaceReleased()
			{
				console.log("Released Space!");
				space = false;
			}
			
			//Task Constants
			var distanceBetweenPoints = 32;
			var minDistFromCenter = 80;
			var maxDistFromCenter = 180;
			var maxCurveHeight = 32;
			var centerHeight = 240;
			
			var maxDistFromCenter_taskThree = 230
			var minDistFromCenter_taskThree = 220;
			
			var vaginaPeakIndex = 30;
			var minDistFromCenter_hole = 50;
			var maxDistFromCenter_hole = 50;
			
			var fallopianTubePeakIndex = 60;
			var minDistFromCenter_fallopianTube = 80;
			var maxDistFromCenter_fallopianTube = 110;
			
			var finishPeakIndex = 85;
			
			var lightPink = '#ffc4bc';
			var darkPink = '#ff7379';
			var black = '#000000';
			var yellow = '#FFD966';
			var brown = '#7F6000';
			//var green = '#61bf26'; //(current unused)
			
			var sperm_image = new Image();
			sperm_image.src = 'sperm.png';
			
			var sperm2_image = new Image();
			sperm2_image.src = 'sperm2.png';
			
			var sperm_image_height = 93;
			var sperm_image_width = 367;
			var sperm_scale = 1/3;
			
			var egg_image = new Image();
			egg_image.src = 'egg.png';
			var egg_scale = 1/4;
			var egg_zp3_scale = 1/3;
			
			var egg_image_height = 527;
			var egg_image_width = 527;
			
			var egg_zp3_image = new Image();
			egg_zp3_image.src = 'egg_zp3.png';
			
			var egg_zp3_image_height = 1113;
			var egg_zp3_image_width = 1146;
			
			var maxDistFromCenter_calcium = minDistFromCenter_fallopianTube - 15;
			var calcium_radius = 23;
			
			var sperm_hitbox_radius = 10;
			var sperm_hitbox_x = sperm_image_width * sperm_scale * 0.9;
			var sperm_hitbox_y = sperm_image_height * sperm_scale * 0.7;
			
			var sperm_gravity = 0.8;
			var sperm_jump_speed = 8;
			var scrollSpeed = 5;
			
			var targetCalcium = 10;
			
			var egg_x = 300;
			var egg_y = centerHeight - egg_zp3_image_height*egg_zp3_scale/2;
			
			var aimStartDistance = 20;
			var aimEndDistance = 60;
			
			//Task Setup Variables
			var topPoints;
			var bottomPoints;
			var calciumPoints;
			var PointsGenerated;
			var mostRecentGeneratedTopHeight;
			var mostRecentGeneratedBottomHeight;
			var calciumCollected;
			
			var peaksGenerated;
			
			var sperm_x;
			var sperm_y;
			var sperm_speed;
			var sperm_direction;
			
			var dangerPointIndex;
			var dangerPoint;
			
			var tailMoveCounter;
			var tailSpeed;
			var tailImageIndex;
			
			var createdEgg;
			var gotEgg;
			
			var spermAimRange;
			var spermAimRangeStart;
			var spermAimSpeed;
			var spermAimCounter;
			
			var zpPoints;
			var zpRadius = 10;
			
			function setupTaskOne()
			{
				console.log("Setting up Task One");
				taskSetUp[taskIndex] = true;
				
				sperm_x = distanceBetweenPoints * 2;
				sperm_y = centerHeight;
				sperm_speed = 0;
				
				dangerPointIndex = -1;
				dangerPoint = {x:-1, y:-1};
				
				pointsGenerated = 0;
				peaksGenerated = 0;
				
				topPoints = [];
				bottomPoints = [];
				
				tailSpeed = 10;
				tailMoveCounter = 0;
				tailImageIndex = 1;
				
				for (let i = 0; i < 640 + distanceBetweenPoints*3; i += distanceBetweenPoints)
				{
					addPoints(i);
				}
			}
			
			function setupTaskTwo()
			{
				console.log("Setting up Task Two");
				taskSetUp[taskIndex] = true;
				
				sperm_x = distanceBetweenPoints * 2;
				sperm_y = centerHeight;
				sperm_speed = 0;
				
				dangerPointIndex = -1;
				dangerPoint = {x:-1, y:-1};
				
				pointsGenerated = 0;
				peaksGenerated = 60; //start in the fallopian tube
				
				topPoints = [];
				bottomPoints = [];
				calciumPoints = [];
				calciumCollected = 0;
				
				tailSpeed = 10;
				tailMoveCounter = 0;
				tailImageIndex = 1;
				
				createdEgg = false;
				gotEgg = false;
				
				for (let i = 0; i < 640 + distanceBetweenPoints*3; i += distanceBetweenPoints)
				{
					addPoints(i);
					calciumPoints.push(-1);
				}
			}
			
			function setupTaskThree()
			{
				console.log("Setting up Task Two");
				taskSetUp[taskIndex] = true;
				
				sperm_x = distanceBetweenPoints;
				sperm_y = centerHeight;
				sperm_speed = 0;
				
				topPoints = [];
				bottomPoints = [];
				pointsGenerated = 0;
				peaksGenerated = 0;
				
				tailSpeed = 2.5;
				tailMoveCounter = 0;
				tailImageIndex = 1;
				
				spermAimRange = 90;
				spermAimRangeStart = 45;
				spermAimSpeed = 1;
				spermAimCounter = 0;
				
				sperm_speed = 0;
				sperm_direction = 0;
				
				zpPoints = [];
				
				zpPoints.push({x: egg_x + 20, y: egg_y + 130});
				zpPoints.push({x: egg_x + 11, y: egg_y + 185});
				zpPoints.push({x: egg_x + 21, y: egg_y + 243});
				zpPoints.push({x: egg_x + 45, y: egg_y + 295});
				
				for (let i = 0; i < 640 + distanceBetweenPoints*3; i += distanceBetweenPoints)
				{
					addPoints(i);
				}
				
				gotEgg = false; //repurposing this for ZP3
			}
			
			function addPoints(xCoordinate)
			{
				if (pointsGenerated == 0)
				{
					if (taskIndex == 2)
					{
						mostRecentGeneratedTopHeight = centerHeight - minDistFromCenter_taskThree - Math.floor((Math.random() * (maxDistFromCenter_taskThree - minDistFromCenter_taskThree)));
						
						mostRecentGeneratedBottomHeight = centerHeight + minDistFromCenter_taskThree + Math.floor((Math.random() * (maxDistFromCenter_taskThree - minDistFromCenter_taskThree)));
					}
					else if ((peaksGenerated == vaginaPeakIndex) || (peaksGenerated == fallopianTubePeakIndex))
					{
						mostRecentGeneratedTopHeight = centerHeight - minDistFromCenter_hole - Math.floor((Math.random() * (maxDistFromCenter_hole - minDistFromCenter_hole)));
						
						mostRecentGeneratedBottomHeight = centerHeight + minDistFromCenter_hole + Math.floor((Math.random() * (maxDistFromCenter_hole - minDistFromCenter_hole)));
					}
					else if (peaksGenerated > fallopianTubePeakIndex)
					{
						mostRecentGeneratedTopHeight = centerHeight - minDistFromCenter_fallopianTube - Math.floor((Math.random() * (maxDistFromCenter_fallopianTube - minDistFromCenter_fallopianTube)));
						
						mostRecentGeneratedBottomHeight = centerHeight + minDistFromCenter_fallopianTube + Math.floor((Math.random() * (maxDistFromCenter_fallopianTube - minDistFromCenter_fallopianTube)));
					}
					else if (peaksGenerated > finishPeakIndex)
					{
						completeTask();
					}
					else
					{
						mostRecentGeneratedTopHeight = centerHeight - minDistFromCenter - Math.floor((Math.random() * (maxDistFromCenter - minDistFromCenter)));
						
						mostRecentGeneratedBottomHeight = centerHeight + minDistFromCenter + Math.floor((Math.random() * (maxDistFromCenter - minDistFromCenter)));
					}
					
					peaksGenerated++;
				}
				else
				{
					mostRecentGeneratedTopHeight = mostRecentGeneratedTopHeight - maxCurveHeight/2 + maxCurveHeight*Math.random();
					mostRecentGeneratedBottomHeight = mostRecentGeneratedBottomHeight - maxCurveHeight/2 + maxCurveHeight*Math.random();
				}
				
				pointsGenerated++;
				if (pointsGenerated == 2)
				{
					pointsGenerated = 0;
				}
				
				topPoints.push(
					{x: xCoordinate, y: mostRecentGeneratedTopHeight}
				);
				bottomPoints.push(
					{x: xCoordinate, y: mostRecentGeneratedBottomHeight}
				);
			}
			
			function taskThree()
			{
				if (taskSetUp[taskIndex] == false)
				{
					setupTaskThree();
				}
				
				tailMoveCounter++;
				if (tailMoveCounter > tailSpeed)
				{
					tailMoveCounter = 0;
					tailImageIndex++;
					if (tailImageIndex == 3)
					{
						tailImageIndex = 1;
					}
				}
				
				if (sperm_speed > 0)
				{
					var newSpermX = sperm_x + Math.cos(sperm_direction * Math.PI / 180) * sperm_speed;
					var newSpermY = sperm_y + Math.sin(sperm_direction * Math.PI / 180) * sperm_speed;
					
					sperm_x = newSpermX;
					sperm_y = newSpermY;
					
					for (let i = 0; i < zpPoints.length; i++)
					{
						if (Math.abs(zpPoints[i].x - sperm_x - sperm_hitbox_x) < 30)
						{
							var x_dif = sperm_x + sperm_hitbox_x - zpPoints[i].x;
							var y_dif = sperm_y + sperm_hitbox_y - zpPoints[i].y;
							var dist = Math.sqrt(x_dif*x_dif + y_dif*y_dif);
							
							if (dist < sperm_hitbox_radius + zpRadius)
							{
								gotEgg = true;
								completeTask();
							}
						}
					}
					
					if ((sperm_x + sperm_hitbox_x > 700) 
						|| (sperm_y + sperm_hitbox_y < 0) 
						|| (sperm_y + sperm_hitbox_y > 480))
					{
						showGame();
					}
				}
				else
				{
					spermAimCounter += spermAimSpeed;
					if (spermAimCounter >= spermAimRange)
					{
						spermAimSpeed = Math.abs(spermAimSpeed) * -1;
					}
					else if (spermAimCounter <= 0)
					{
						spermAimSpeed = Math.abs(spermAimSpeed)
					}
					
					if ((space) && (sperm_speed == 0))
					{
						sperm_direction = spermAimRangeStart - spermAimCounter;
						sperm_speed = 3;
					}
				}
				
				drawTaskThree();
				console.log("Task Three Loop");
			}
			
			function taskTwo()
			{
				if (taskSetUp[taskIndex] == false)
				{
					setupTaskTwo();
				}
				
				//Move points to the left
				for (let i = 0; i < topPoints.length; i++)
				{
					topPoints[i].x -= scrollSpeed;
					bottomPoints[i].x -= scrollSpeed;
				}
				
				if (topPoints[0].x < -distanceBetweenPoints)
				{
					topPoints.shift();
					bottomPoints.shift();
					calciumPoints.shift();
					addPoints(topPoints[topPoints.length-1].x+distanceBetweenPoints);
					if (Math.floor(Math.random()*5) == 0)
					{
						if (calciumCollected < targetCalcium)
						{
							var randCalciumPoint = centerHeight - maxDistFromCenter_calcium + Math.random()*maxDistFromCenter_calcium*2;
							calciumPoints.push(randCalciumPoint);
						}
						else if (!createdEgg)
						{
							calciumPoints.push(-2);
							createdEgg = true;
						}
						else
						{
							calciumPoints.push(-1);
						}
					}
					else
					{
						calciumPoints.push(-1);
					}
				}
				
				for (let i = 0; i < topPoints.length - 1; i++)
				{
					if ((sperm_x + sperm_hitbox_x >= topPoints[i].x) 
					&& (sperm_x + sperm_hitbox_x <= topPoints[i+1].x))
					{
						dangerPointIndex = i;
						i = topPoints.length;
					}
				}
				
				if (dangerPointIndex > 0)
				{
					var x1 = topPoints[dangerPointIndex].x;
					var x2 = topPoints[dangerPointIndex+1].x;
					var y1 = topPoints[dangerPointIndex].y;
					var y2 = topPoints[dangerPointIndex+1].y;
					
					var slope = (y2 - y1) / (x2 - x1);
					var y_intercept = y1 - (slope * x1);
					var dangerY_top = slope * (sperm_x + sperm_hitbox_x) + y_intercept;
					
					x1 = bottomPoints[dangerPointIndex].x;
					x2 = bottomPoints[dangerPointIndex+1].x;
					y1 = bottomPoints[dangerPointIndex].y;
					y2 = bottomPoints[dangerPointIndex+1].y;
					
					slope = (y2 - y1) / (x2 - x1);
					y_intercept = y1 - (slope * x1);
					var dangerY_bottom = slope * (sperm_x + sperm_hitbox_x) + y_intercept;
					
					var sperm_calculatedPosition_y = sperm_y + sperm_hitbox_y;
					if ((sperm_calculatedPosition_y - dangerY_top < sperm_hitbox_radius)
					|| (dangerY_bottom - sperm_calculatedPosition_y < sperm_hitbox_radius))
					{
						showGame();
					}
				}
				
				sperm_speed += sperm_gravity;
				sperm_y += sperm_speed;
				
				if (space)
				{
					sperm_speed = -sperm_jump_speed;
				}
				
				tailMoveCounter++;
				if (tailMoveCounter > tailSpeed)
				{
					tailMoveCounter = 0;
					tailImageIndex++;
					if (tailImageIndex == 3)
					{
						tailImageIndex = 1;
					}
				}
				
				for (let i = 0; i < calciumPoints.length; i++)
				{
					if ((calciumPoints[i] > 0) && (Math.abs(topPoints[i].x - sperm_x - sperm_hitbox_x) < calcium_radius + sperm_hitbox_radius))
					{
						var x1 = topPoints[i].x;
						var x2 = sperm_x + sperm_hitbox_x;
						var y1 = calciumPoints[i];
						var y2 = sperm_y + sperm_hitbox_y;
						var distance = Math.sqrt((x1 - x2)*(x1 - x2) + (y1 - y2) * (y1 - y2));
						if (distance < calcium_radius + sperm_hitbox_radius)
						{
							calciumPoints[i] = -1;
							tailSpeed -= 0.75;
							if (tailSpeed <= 0)
							{
								tailSpeed = 0.5;
							}
							calciumCollected++;
						}
					}
					else if (calciumPoints[i] == -2)
					{
						if (Math.abs(sperm_x + sperm_hitbox_x - topPoints[i].x) < sperm_hitbox_radius + 75)
						{
							gotEgg = true;
							completeTask();
						}
					}
				}
				
				drawTaskTwo();
				console.log("Task Two Loop");
			}

			function taskOne()
			{
				if (taskSetUp[taskIndex] == false)
				{
					setupTaskOne();
				}
				
				//Move points to the left
				for (let i = 0; i < topPoints.length; i++)
				{
					topPoints[i].x -= scrollSpeed;
					bottomPoints[i].x -= scrollSpeed;
				}
				
				if (topPoints[0].x < -distanceBetweenPoints)
				{
					topPoints.shift();
					bottomPoints.shift();
					addPoints(topPoints[topPoints.length-1].x+distanceBetweenPoints);
				}
				
				for (let i = 0; i < topPoints.length - 1; i++)
				{
					if ((sperm_x + sperm_hitbox_x >= topPoints[i].x) 
					&& (sperm_x + sperm_hitbox_x <= topPoints[i+1].x))
					{
						dangerPointIndex = i;
						i = topPoints.length;
					}
				}
				
				if (dangerPointIndex > 0)
				{
					var x1 = topPoints[dangerPointIndex].x;
					var x2 = topPoints[dangerPointIndex+1].x;
					var y1 = topPoints[dangerPointIndex].y;
					var y2 = topPoints[dangerPointIndex+1].y;
					
					var slope = (y2 - y1) / (x2 - x1);
					var y_intercept = y1 - (slope * x1);
					var dangerY_top = slope * (sperm_x + sperm_hitbox_x) + y_intercept;
					
					x1 = bottomPoints[dangerPointIndex].x;
					x2 = bottomPoints[dangerPointIndex+1].x;
					y1 = bottomPoints[dangerPointIndex].y;
					y2 = bottomPoints[dangerPointIndex+1].y;
					
					slope = (y2 - y1) / (x2 - x1);
					y_intercept = y1 - (slope * x1);
					var dangerY_bottom = slope * (sperm_x + sperm_hitbox_x) + y_intercept;
					
					var sperm_calculatedPosition_y = sperm_y + sperm_hitbox_y;
					if ((sperm_calculatedPosition_y - dangerY_top < sperm_hitbox_radius)
					|| (dangerY_bottom - sperm_calculatedPosition_y < sperm_hitbox_radius))
					{
						showGame();
					}
				}
				
				sperm_speed += sperm_gravity;
				sperm_y += sperm_speed;
				
				if (space)
				{
					sperm_speed = -sperm_jump_speed;
				}
				
				tailMoveCounter++;
				if (tailMoveCounter > tailSpeed)
				{
					tailMoveCounter = 0;
					tailImageIndex++;
					if (tailImageIndex == 3)
					{
						tailImageIndex = 1;
					}
				}
				
				drawTaskOne();
				console.log("Task One Loop");
			}
			
			function drawTaskOne()
			{
				ctx.fillStyle = lightPink;
				
				//Background
				ctx.beginPath();
				ctx.fillRect(0, 0, 640, 480);
				
				//Top Walls
				ctx.fillStyle = darkPink;
				ctx.beginPath();
				ctx.moveTo(0, 0);
				for (let i = 0; i < topPoints.length - 1; i++)
				{
					ctx.lineTo(topPoints[i].x, topPoints[i].y);
				}
				ctx.lineTo(640, 0);
				ctx.closePath();
				ctx.fill();
				
				//Bottom Walls
				ctx.beginPath();
				ctx.moveTo(0, 480);
				for (let i = 0; i < bottomPoints.length - 1; i++)
				{
					ctx.lineTo(bottomPoints[i].x, bottomPoints[i].y);
				}
				ctx.lineTo(640, 480);
				ctx.closePath();
				ctx.fill();
				
				//Lines
				ctx.strokeStyle = black;
				ctx.beginPath();
				for (let i = 0; i < topPoints.length - 1; i++)
				{
					ctx.moveTo(topPoints[i].x, topPoints[i].y);
					ctx.lineTo(topPoints[i+1].x, topPoints[i+1].y);
					
					ctx.moveTo(bottomPoints[i].x, bottomPoints[i].y);
					ctx.lineTo(bottomPoints[i+1].x, bottomPoints[i+1].y);
				}
				ctx.stroke();
				
				if (tailImageIndex == 1)
				{
					ctx.drawImage(sperm_image, sperm_x, sperm_y, sperm_image_width*sperm_scale, sperm_image_height*sperm_scale);
				}
				else
				{
					var upsidedown_sperm_y = sperm_y + sperm_image_height*sperm_scale - sperm_hitbox_y;
					
					ctx.drawImage(sperm2_image, sperm_x, upsidedown_sperm_y, sperm_image_width*sperm_scale, sperm_image_height*sperm_scale);
				}
				
				if ((peaksGenerated > finishPeakIndex) && (taskIndex == 0))
				{
					ctx.textAlign = "center";
					ctx.fillStyle = black;
					ctx.font = "30px Impact";
					ctx.fillText("Task Complete!", 320, 200);
				}
			}
			
			function drawTaskTwo()
			{
				drawTaskOne();
				for (let i = 0; i < calciumPoints.length; i++)
				{
					if (calciumPoints[i] > 0)
					{
						var calcium_x = topPoints[i].x + calcium_radius/2;
						var calcium_y = calciumPoints[i] + calcium_radius/2;
						
						ctx.fillStyle = yellow;
						ctx.beginPath()
						ctx.arc(
							calcium_x,
							calcium_y,
							calcium_radius,
							0, 2*Math.PI
						);
						ctx.fill();
						
						ctx.strokeStyle = brown;
						ctx.beginPath()
						ctx.arc(
							calcium_x,
							calcium_y,
							calcium_radius,
							0, 2*Math.PI
						);
						ctx.stroke();
						
						ctx.textAlign = "center";
						ctx.fillStyle = black;
						ctx.font = "20px Arial";
						ctx.fillText("Ca", calcium_x - 5, calcium_y + 8);
						ctx.font = "14px Arial";
						ctx.fillText("2+", calcium_x + 15, calcium_y + 2);
					}
					else if (calciumPoints[i] == -2)
					{
						ctx.drawImage(egg_image, topPoints[i].x, centerHeight - egg_image_height*egg_scale/2, egg_image_width*egg_scale, egg_image_height*egg_scale);
					}
				}
				
				if (gotEgg)
				{
					ctx.textAlign = "center";
					ctx.fillStyle = black;
					ctx.font = "30px Impact";
					ctx.fillText("Task Complete!", 320, 200);
				}
			}
			
			function drawTaskThree()
			{
				drawTaskOne();
				
				ctx.drawImage(
					egg_zp3_image, 
					egg_x, egg_y, 
					egg_zp3_image_width*egg_zp3_scale, 
					egg_zp3_image_height*egg_zp3_scale
				);
				
				if (sperm_speed == 0)
				{
					var spermAimAngle = spermAimRangeStart - spermAimCounter;
					
					var aim_start_x = Math.cos(spermAimAngle * Math.PI / 180) * aimStartDistance + sperm_x + sperm_hitbox_x;
					var aim_start_y = Math.sin(spermAimAngle * Math.PI / 180) * aimStartDistance + sperm_y + sperm_hitbox_y;
					
					var aim_end_x = Math.cos(spermAimAngle * Math.PI / 180) * aimEndDistance + sperm_x + sperm_hitbox_x;
					var aim_end_y =Math.sin(spermAimAngle * Math.PI / 180) * aimEndDistance + sperm_y + sperm_hitbox_y;
					
					ctx.strokeStyle = darkPink;
					ctx.lineWidth = 5;
					ctx.lineCap = 'round';
					ctx.beginPath();
					ctx.moveTo(aim_start_x, aim_start_y);
					ctx.lineTo(aim_end_x, aim_end_y);
					
					ctx.stroke();
					
					ctx.beginPath();
					ctx.arc(
						sperm_x + sperm_hitbox_x,
						sperm_y + sperm_hitbox_y,
						aimStartDistance,
						(spermAimAngle - 45) * Math.PI / 180,
						(spermAimAngle + 45) * Math.PI / 180
					);
					
					ctx.stroke();
					
					ctx.lineWidth = 1;
				}
				
				/*for (let i = 0; i < zpPoints.length; i++)
				{
					ctx.fillStyle = black;
					ctx.beginPath();
					ctx.arc(
						zpPoints[i].x,
						zpPoints[i].y,
						zpRadius,
						0, 2*Math.PI
					);
					ctx.fill();
				}*/
				
				if (gotEgg)
				{
					ctx.textAlign = "center";
					ctx.fillStyle = black;
					ctx.font = "30px Impact";
					ctx.fillText("Task Complete!", 320, 200);
				}
			}
			
		</script>
	</body>
</html>
