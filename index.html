<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Reproductive Biology</title>
		<style type="text/css">
			#gameCanvas {
				outline: solid 1px black;
			}
			#infoDiv {
				outline: solid 1px black;
				height: 480px;
				width: 640px;
				text-align: center;
			}
			#buttonDiv {
				text-align: center;
				width: 640px;
				margin: 10px;
			}
			#previousButton, nextButton {
				display: inline-block;
			}
		</style>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, width=device-width, user-scalable=no" />
	</head>
	<body onload="loadPage()">
		<div id="infoDiv">
			<h1 id="header"></h1>
			<h2 id="description"><h2>
			<h2 id="instructions"><h2>
			<h2>Press Space to Begin!</h2>
		</div>
		<canvas id="gameCanvas" width="0" height="0" onclick="canvasClick(event)"></canvas>
		<div id="buttonDiv">
			<button id="previousButton" onclick="previousTask()"><h3>Previous Task</h3></button>
			<button id="nextButton" onclick="nextTask()"><h3>Next Task</h3></button>
		</div>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" type="text/javascript"></script>
		<script type="text/javascript">
		
			var gameCanvas = document.getElementById("gameCanvas");
			var ctx = gameCanvas.getContext("2d");
			
			var mode = "info";
			var taskIndex = 0;
			var gameInterval;
			
			var tasks = 
			[
				{
					header: "Finding the Fallopian Tube",
					description: "Educational description goes here.",
					instructions: "Tap the space bar to hop all the way to the fallopian tube!"
				},
				{
					header: "Collecting Calcium",
					description: "Educational description goes here.",
					instructions: "Tap the space bar to collect calcium on the way to the egg!"
				},
				{
					header: "Arriving at the Egg",
					description: "Educational description goes here.",
					instructions: "Tap the space bar at the perfect moment to attach to ZP3 on the outside of the egg."
				},
				{
					header: "Binding to ZP3",
					description: "Educational description goes here.",
					instructions: "Tap the space bar to bind to ZP3 and penetrate the first layer of the egg."
				},
				{
					header: "Releasing the Nucleus",
					description: "Educational description goes here.",
					instructions: "Tap the space bar to fuse to the egg, then click the PLCzeta to release a calcium wave."
				},
				{
					header: "Fusing Corticle Granules with the Egg",
					description: "Educational description goes here.",
					instructions: "Click the corticle granules to fuse them with the egg."
				}
			];
			
			var gameLoops =
			[
				taskOne,
				taskTwo,
				taskThree,
				taskFour,
				taskFive,
				taskSix
			];
			
			var taskSetUp = [];
			
			function showInfo()
			{
				$(gameCanvas).css('display', 'none');
				$('#infoDiv').css('display', 'block');
				
				var task = tasks[taskIndex];
				$('#header').html(task.header);
				$('#description').html(task.description);
				$('#instructions').html(task.instructions);
				
				mode = "info";
				setupButtons();
				clearInterval(gameInterval);
			}
			
			function canvasClick()
			{
				if ((mode == "game") 
				&& (taskIndex == 4) 
				&& (sperm_speed > 0)
				&& (colorIndex == -1)
				&& (plcz_alpha > 0.5))
				{
					var rect = gameCanvas.getBoundingClientRect();
					var mouseX = event.clientX - rect.left;
					var mouseY = event.clientY - rect.top;
					
					if ((mouseX >= egg_x + 60) 
					&& (mouseX <= egg_x + 60 + PLCZ_image_width/2)
					&& (mouseY >= egg_y + 225) 
					&& (mouseY <= egg_y + 225 + PLCZ_image_height/2))
					{
						colorIndex = 1;
					}
				}
				else if ((mode == "game")
				&& (taskIndex == 5))
				{
					var rect = gameCanvas.getBoundingClientRect();
					var mouseX = event.clientX - rect.left;
					var mouseY = event.clientY - rect.top;
					
					for (let i = 0; i < calciumPoints.length; i++)
					{
						if ((calciumPoints[i].speed == 0)
						&& (Math.abs(mouseX - calciumPoints[i].x) < granule_image_width*granule_scale/2)
						&& (Math.abs(mouseY - calciumPoints[i].y) < granule_image_height*granule_scale/2))
						{
							calciumPoints[i].speed = 8;
						}
					}
				}
			}
			
			function showGame()
			{
				$(gameCanvas).css('display', 'block');
				$('#infoDiv').css('display', 'none');
				
				mode = "game";
				resetTasks();
				clearInterval(gameInterval);
				gameInterval = setInterval(gameLoops[taskIndex], 35); //Approx 30 frames per second
			}
			
			function resetTasks()
			{
				for (let i = 0; i < taskSetUp.length; i++)
				{
					taskSetUp[i] = false;
				}
			}
			
			function completeTask()
			{
				clearInterval(gameInterval);
			}
			
			function loadPage()
			{
				gameCanvas.width = 640;
				gameCanvas.height = 480;
				
				for (let i = 0; i < tasks.length; i++)
				{
					taskSetUp.push(false);
				}
				
				document.addEventListener('keydown', (e) => 
					{
						if (e.code === "ArrowUp")
						{
							arrowPressed("Up");
						}
						else if (e.code === "ArrowDown")
						{
							arrowPressed("Down");
						}
						else if (e.code === "ArrowLeft")
						{
							arrowPressed("Left");
						}
						else if (e.code === "ArrowRight")
						{
							arrowPressed("Right");
						}
						else if (e.code === "Space")
						{
							spacePressed();
						}
					}
				);
				
				document.addEventListener('keyup', (e) => 
					{
						if (e.code === "ArrowUp")
						{
							arrowReleased("Up");
						}
						else if (e.code === "ArrowDown")
						{
							arrowReleased("Down");
						}
						else if (e.code === "ArrowLeft")
						{
							arrowReleased("Left");
						}
						else if (e.code === "ArrowRight")
						{
							arrowReleased("Right");
						}
						else if (e.code === "Space")
						{
							spaceReleased();
						}
					}
				);
				
				taskIndex = 0;
				showInfo();
			}
			
			function setupButtons()
			{
				$('#nextButton').css('min-width', $('#previousButton').css('width'));
				$('#previousButton').prop('disabled', taskIndex == 0);
				$('#nextButton').prop('disabled', taskIndex == tasks.length - 1);
			}
			
			function previousTask()
			{
				if (taskIndex > 0)
				{
					taskIndex--;
					showInfo();
					$('#previousButton').blur();
				}
			}
			
			function nextTask()
			{
				if (taskIndex < tasks.length - 1)
				{
					taskIndex++;
					showInfo();
					$('#infoDiv').focus();
					$('#nextButton').blur();
				}
			}
			
			var up = false;
			var down = false;
			var left = false;
			var right = false;
			var space = false;
			
			function arrowPressed(direction)
			{
				console.log("Pressed " + direction + "!");
				switch (direction)
				{
					case "Up":
						up = true;
						break;
					case "Down":
						down = true;
						break;
					case "Left":
						left = true;
						break;
					case "Right":
						right = true;
						break;
				}
			}
			
			function arrowReleased(direction)
			{
				console.log("Released " + direction + "!");
				switch (direction)
				{
					case "Up":
						up = false;
						break;
					case "Down":
						down = false;
						break;
					case "Left":
						left = false;
						break;
					case "Right":
						right = false;
						break;
				}
			}
			
			function spacePressed()
			{
				if (mode == "info")
				{
					showGame(taskIndex);
				}
				else
				{
					console.log("Pressed Space!");
					space = true;
				}
			}
			
			function spaceReleased()
			{
				console.log("Released Space!");
				if ((taskIndex != 3) && (taskIndex != 4))
				{
					space = false;
				}
			}
			
			//Task Constants
			var distanceBetweenPoints = 32;
			var minDistFromCenter = 80;
			var maxDistFromCenter = 180;
			var maxCurveHeight = 32;
			var centerHeight = 240;
			
			var maxDistFromCenter_taskThree = 230
			var minDistFromCenter_taskThree = 220;
			
			var vaginaPeakIndex = 30;
			var minDistFromCenter_hole = 50;
			var maxDistFromCenter_hole = 50;
			
			var fallopianTubePeakIndex = 60;
			var minDistFromCenter_fallopianTube = 80;
			var maxDistFromCenter_fallopianTube = 110;
			
			var finishPeakIndex = 85;
			
			var lightPink = '#ffc4bc';
			var darkPink = '#ff7379';
			var black = '#000000';
			var yellow = '#FFD966';
			var brown = '#7F6000';
			//var green = '#61bf26'; //(current unused)
			
			var sperm_image = new Image();
			sperm_image.src = 'sperm.png';
			
			var sperm2_image = new Image();
			sperm2_image.src = 'sperm2.png';
			
			var sperm_tan_image = new Image();
			sperm_tan_image.src = 'sperm_tan_small.png';
			
			var sperm_image_height = 93;
			var sperm_image_width = 367;
			var sperm_scale = 1/3;
			
			var sperm_tan_image_height = 53;
			var sperm_tan_image_width = 176;
			
			var egg_image = new Image();
			egg_image.src = 'egg.png';
			var egg_scale = 1/4;
			var egg_zp3_scale = 1/3;
			
			var egg_image_height = 527;
			var egg_image_width = 527;
			
			var egg_zp3_image = new Image();
			egg_zp3_image.src = 'egg_zp3.png';
			
			var egg_zp3_image_height = 1113;
			var egg_zp3_image_width = 1146;
			
			var egg_no_zp3_image = new Image();
			egg_no_zp3_image.src = 'egg_no_zp3.png';
			
			var egg_no_zp3_image_height = 1113;
			var egg_no_zp3_image_width = 1146;
			
			var puff_image = new Image();
			puff_image.src = 'puff.png';
			
			var puff_brown_image = new Image();
			puff_brown_image.src = 'puff_brown.png';
			
			puff_image_height = 106;
			puff_image_width = 78;
			
			var sperm_nucleus_image = new Image();
			sperm_nucleus_image.src = 'sperm_nucleus.png';
			
			var sperm_nucleus_image_height = 77;
			var sperm_nucleus_image_width = 77;
			
			var PLCZ_image = new Image();
			PLCZ_image.src = 'PLCZ.png';
			
			var PLCZ_image_height = 71;
			var PLCZ_image_width = 125;
			
			var egg_red_image = new Image();
			egg_red_image.src = 'egg_red.png';
			var egg_orange_image = new Image();
			egg_orange_image.src = 'egg_orange.png';
			var egg_yellow_image = new Image();
			egg_yellow_image.src = 'egg_yellow.png';
			var egg_green_image = new Image();
			egg_green_image.src = 'egg_green.png';
			var egg_blue_image = new Image();
			egg_blue_image.src = 'egg_blue.png';
			var egg_purple_image = new Image();
			egg_purple_image.src = 'egg_purple.png';
			
			var granule_image = new Image();
			granule_image.src = 'granule.png';
			
			var egg_sperm_nucleus_image = new Image();
			egg_sperm_nucleus_image.src = 'egg_sperm_nucleus.png';
			
			var granule_image_width = 32;
			var granule_image_height = 32;
			
			var granule_scale = 1/2;
			
			var maxDistFromCenter_calcium = minDistFromCenter_fallopianTube - 15;
			var calcium_radius = 23;
			
			var sperm_hitbox_radius = 10;
			var sperm_hitbox_x = sperm_image_width * sperm_scale * 0.9;
			var sperm_hitbox_y = sperm_image_height * sperm_scale * 0.7;
			
			var sperm_gravity = 0.8;
			var sperm_jump_speed = 8;
			var scrollSpeed = 5;
			
			var targetCalcium = 10;
			
			var egg_x = 300;
			var egg_y = centerHeight - egg_zp3_image_height*egg_zp3_scale/2;
			
			var aimStartDistance = 20;
			var aimEndDistance = 60;
			
			var gh_line_X = 100;
			var gh_line_Y1 = 70;
			var gh_line_Y2 = 410;
			
			var zpRadius = 10;
			
			var gh_radius = 10;
			
			//Task Setup Variables
			var topPoints;
			var bottomPoints;
			var calciumPoints;
			var PointsGenerated;
			var mostRecentGeneratedTopHeight;
			var mostRecentGeneratedBottomHeight;
			var calciumCollected;
			
			var peaksGenerated;
			
			var sperm_x;
			var sperm_y;
			var sperm_speed;
			var sperm_direction;
			
			var sperm_x_offset;
			
			var sperm_box_x;
			var sperm_box_y;
			
			var dangerPointIndex;
			var dangerPoint;
			
			var tailMoveCounter;
			var tailSpeed;
			var tailImageIndex;
			
			var createdEgg;
			var gotEgg;
			
			var spermAimRange;
			var spermAimRangeStart;
			var spermAimSpeed;
			var spermAimCounter;
			
			var zpPoints;
			
			var gh_cursorSpeed;
			var gh_cursorSpeedDefault;
			var gh_cursorPosition;
			var gh_successfulHit;
			var gh_nextHitIndex;
			var gh_messageText;
			
			var puff_size;
			var puff_size_modifier;
			
			var plcz_alpha;
			
			var colorIndex;
			
			function setupTaskOne()
			{
				console.log("Setting up Task One");
				taskSetUp[taskIndex] = true;
				
				sperm_x = distanceBetweenPoints * 2;
				sperm_y = centerHeight;
				sperm_speed = 0;
				
				dangerPointIndex = -1;
				dangerPoint = {x:-1, y:-1};
				
				pointsGenerated = 0;
				peaksGenerated = 0;
				
				topPoints = [];
				bottomPoints = [];
				
				tailSpeed = 10;
				tailMoveCounter = 0;
				tailImageIndex = 1;
				
				for (let i = 0; i < 640 + distanceBetweenPoints*3; i += distanceBetweenPoints)
				{
					addPoints(i);
				}
			}
			
			function setupTaskTwo()
			{
				console.log("Setting up Task Two");
				taskSetUp[taskIndex] = true;
				
				sperm_x = distanceBetweenPoints * 2;
				sperm_y = centerHeight;
				sperm_speed = 0;
				
				dangerPointIndex = -1;
				dangerPoint = {x:-1, y:-1};
				
				pointsGenerated = 0;
				peaksGenerated = 60; //start in the fallopian tube
				
				topPoints = [];
				bottomPoints = [];
				calciumPoints = [];
				calciumCollected = 0;
				
				tailSpeed = 10;
				tailMoveCounter = 0;
				tailImageIndex = 1;
				
				createdEgg = false;
				gotEgg = false;
				
				for (let i = 0; i < 640 + distanceBetweenPoints*3; i += distanceBetweenPoints)
				{
					addPoints(i);
					calciumPoints.push(-1);
				}
			}
			
			function setupTaskThree()
			{
				console.log("Setting up Task Three");
				taskSetUp[taskIndex] = true;
				
				sperm_x = distanceBetweenPoints;
				sperm_y = centerHeight;
				sperm_speed = 0;
				
				topPoints = [];
				bottomPoints = [];
				pointsGenerated = 0;
				peaksGenerated = 0;
				
				tailSpeed = 2.5;
				tailMoveCounter = 0;
				tailImageIndex = 1;
				
				spermAimRange = 90;
				spermAimRangeStart = 45;
				spermAimSpeed = 1;
				spermAimCounter = 0;
				
				sperm_speed = 0;
				
				zpPoints = [];
				
				zpPoints.push({x: egg_x + 20, y: egg_y + 130});
				zpPoints.push({x: egg_x + 11, y: egg_y + 185});
				zpPoints.push({x: egg_x + 21, y: egg_y + 243});
				zpPoints.push({x: egg_x + 45, y: egg_y + 295});
				
				for (let i = 0; i < 640 + distanceBetweenPoints*3; i += distanceBetweenPoints)
				{
					addPoints(i);
				}
				
				gotEgg = false; //repurposing this for ZP3
			}
			
			function setupTaskFour()
			{
				console.log("Setting up Task Four");
				taskSetUp[taskIndex] = true;
				
				sperm_x = 177;
				sperm_y = centerHeight - 20;
				sperm_speed = 0;
				
				topPoints = [];
				bottomPoints = [];
				pointsGenerated = 0;
				peaksGenerated = 0;
				
				tailSpeed = 2.5;
				tailMoveCounter = 0;
				tailImageIndex = 1;
				
				sperm_speed = 0;
				sperm_direction = 0;
				
				puff_size = 0;
				puff_size_modifier = 0;
				
				for (let i = 0; i < 640 + distanceBetweenPoints*3; i += distanceBetweenPoints)
				{
					addPoints(i);
				}
				
				zpPoints = []; //repurposing for gh_timing
				
				var totalDistance = gh_line_Y2 - gh_line_Y1;
				var numPoints = 3;
				var distanceBetweenPoints_zp = totalDistance/(numPoints-1);
				for (let i = 0; i < numPoints; i++)
				{
					zpPoints.push(i*distanceBetweenPoints_zp);
				}
				
				gh_cursorSpeed = 0;
				gh_cursorSpeedDefault = 3;
				gh_cursorPosition = gh_line_Y1;
				
				gh_successfulHit = false;
				gh_nextHitIndex = 0;
				gh_messageText = "";
				space = false;
			}
			
			function setupTaskFive()
			{
				console.log("Setting up Task Five");
				taskSetUp[taskIndex] = true;
				space = false;
				
				sperm_x = 211;
				sperm_y = centerHeight - 20;
				sperm_speed = 0;
				sperm_x_offset = 0;
				
				sperm_box_x = sperm_x - 3;
				sperm_box_y = sperm_y + 2;
				
				topPoints = [];
				bottomPoints = [];
				pointsGenerated = 0;
				peaksGenerated = 0;
				colorIndex = -1;
				
				gh_messageText = "";
				
				for (let i = 0; i < 640 + distanceBetweenPoints*3; i += distanceBetweenPoints)
				{
					addPoints(i);
				}
				
				plcz_alpha = 0;
			}
			
			function setupTaskSix()
			{
				console.log("Setting up Task Six");
				taskSetUp[taskIndex] = true;
				
				gh_messageText = "";
				
				topPoints = [];
				bottomPoints = [];
				pointsGenerated = 0;
				peaksGenerated = 0;
				
				calciumPoints = []; //reusing this for granules
				
				calciumPoints.push(newCalciumPoint(70, 240));
				calciumPoints.push(newCalciumPoint(65, 260));
				calciumPoints.push(newCalciumPoint(90, 260));
				calciumPoints.push(newCalciumPoint(80, 280));
				calciumPoints.push(newCalciumPoint(105, 280));
				calciumPoints.push(newCalciumPoint(95, 300));
				calciumPoints.push(newCalciumPoint(115, 310));
				calciumPoints.push(newCalciumPoint(125, 290));
				calciumPoints.push(newCalciumPoint(140, 320));
				calciumPoints.push(newCalciumPoint(155, 300));
				calciumPoints.push(newCalciumPoint(165, 325));
				
				for (let i = 0; i < 640 + distanceBetweenPoints*3; i += distanceBetweenPoints)
				{
					addPoints(i);
				}
				
				colorIndex = 1; //reusing this for egg border radius
			}
			
			function newCalciumPoint(xOffset, yOffset)
			{
				return {
				x: egg_x + xOffset,
				y: egg_y + yOffset,
				speed: 0,
				direction: angle(
					egg_x + egg_image_width*egg_zp3_scale, 
					egg_x + egg_image_width*egg_zp3_scale,
					egg_x + xOffset, 
					egg_y + yOffset),
				imageToDraw: 'granule'
				}
			}
			
			function addPoints(xCoordinate)
			{
				if (pointsGenerated == 0)
				{
					if (taskIndex > 1)
					{
						mostRecentGeneratedTopHeight = centerHeight - minDistFromCenter_taskThree - Math.floor((Math.random() * (maxDistFromCenter_taskThree - minDistFromCenter_taskThree)));
						
						mostRecentGeneratedBottomHeight = centerHeight + minDistFromCenter_taskThree + Math.floor((Math.random() * (maxDistFromCenter_taskThree - minDistFromCenter_taskThree)));
					}
					else if ((peaksGenerated == vaginaPeakIndex) || (peaksGenerated == fallopianTubePeakIndex))
					{
						mostRecentGeneratedTopHeight = centerHeight - minDistFromCenter_hole - Math.floor((Math.random() * (maxDistFromCenter_hole - minDistFromCenter_hole)));
						
						mostRecentGeneratedBottomHeight = centerHeight + minDistFromCenter_hole + Math.floor((Math.random() * (maxDistFromCenter_hole - minDistFromCenter_hole)));
					}
					else if (peaksGenerated > fallopianTubePeakIndex)
					{
						mostRecentGeneratedTopHeight = centerHeight - minDistFromCenter_fallopianTube - Math.floor((Math.random() * (maxDistFromCenter_fallopianTube - minDistFromCenter_fallopianTube)));
						
						mostRecentGeneratedBottomHeight = centerHeight + minDistFromCenter_fallopianTube + Math.floor((Math.random() * (maxDistFromCenter_fallopianTube - minDistFromCenter_fallopianTube)));
					}
					else if (peaksGenerated > finishPeakIndex)
					{
						completeTask();
					}
					else
					{
						mostRecentGeneratedTopHeight = centerHeight - minDistFromCenter - Math.floor((Math.random() * (maxDistFromCenter - minDistFromCenter)));
						
						mostRecentGeneratedBottomHeight = centerHeight + minDistFromCenter + Math.floor((Math.random() * (maxDistFromCenter - minDistFromCenter)));
					}
					
					peaksGenerated++;
				}
				else
				{
					mostRecentGeneratedTopHeight = mostRecentGeneratedTopHeight - maxCurveHeight/2 + maxCurveHeight*Math.random();
					mostRecentGeneratedBottomHeight = mostRecentGeneratedBottomHeight - maxCurveHeight/2 + maxCurveHeight*Math.random();
				}
				
				pointsGenerated++;
				if (pointsGenerated == 2)
				{
					pointsGenerated = 0;
				}
				
				topPoints.push(
					{x: xCoordinate, y: mostRecentGeneratedTopHeight}
				);
				bottomPoints.push(
					{x: xCoordinate, y: mostRecentGeneratedBottomHeight}
				);
			}
			
			function taskSix()
			{
				if (taskSetUp[taskIndex] == false)
				{
					setupTaskSix();
				}
				
				if (calciumPoints.length == 0)
				{
					gh_messageText = "Task Complete";
					completeTask();
				}
				
				for (let i = calciumPoints.length - 1; i >= 0; i--)
				{
					if (calciumPoints[i].speed > 0)
					{
						calciumPoints[i].x += Math.cos(calciumPoints[i].direction * Math.PI / 180);
						calciumPoints[i].y -= Math.sin(calciumPoints[i].direction * Math.PI / 180);
						
						var xDif = egg_x + egg_image_width * egg_zp3_scale + 14 - calciumPoints[i].x;
						var yDif = egg_y + egg_image_width * egg_zp3_scale + 9 - calciumPoints[i].y;
						var distFromCenter = Math.sqrt(xDif*xDif + yDif*yDif);
						
						if (distFromCenter > egg_image_width * egg_zp3_scale)
						{
							calciumPoints.splice(i, 1);
							colorIndex += 1;
						}
						else if ((distFromCenter > egg_image_width * egg_zp3_scale - 15) 
						&& (calciumPoints[i].imageToDraw != 'puff'))
						{
							calciumPoints[i].imageToDraw = 'puff';
							calciumPoints[i].speed = 5;
						}
					}
				}
				
				drawTaskSix();
				console.log("Task Six Loop");
			}
			
			function taskFive()
			{
				if (taskSetUp[taskIndex] == false)
				{
					setupTaskFive();
				}
				
				if (space)
				{
					sperm_speed = 4;
				}
				
				sperm_x_offset += sperm_speed;
				sperm_x += sperm_speed;
				sperm_box_x += sperm_speed;
				if (plcz_alpha < 1)
				{
					plcz_alpha += sperm_speed / 175;
				}
				else if (plcz_alpha > 1)
				{
					plcz_alpha = 1;
				}
				if (colorIndex != -1)
				{
					colorIndex++;
					if (colorIndex >= 30)
					{
						gh_messageText = "Task Complete";
						completeTask();
					}
				}
				
				space = false;
				drawTaskFive();
				console.log("Task Five Loop");
			}
			
			function taskFour()
			{
				if (taskSetUp[taskIndex] == false)
				{
					setupTaskFour();
				}
				
				tailMoveCounter++;
				if (tailMoveCounter > tailSpeed)
				{
					tailMoveCounter = 0;
					tailImageIndex++;
					if (tailImageIndex == 3)
					{
						tailImageIndex = 1;
					}
				}
				
				puff_size += puff_size_modifier;
				gh_cursorPosition += gh_cursorSpeed;
				
				if ((space) && (gh_cursorSpeed == 0))
				{
					gh_cursorSpeed = gh_cursorSpeedDefault;
				}
				else if (gh_cursorPosition >= gh_line_Y2)
				{
					gh_cursorSpeed = 0;
					gh_cursorSpeedDefault = 0;
					gh_cursorPosition = gh_line_Y2;
					gh_messageText = "Task Complete";
					completeTask();
				}
				else if (((Math.abs(gh_line_Y1 + zpPoints[gh_nextHitIndex] - gh_cursorPosition) <= gh_radius)) && (gh_cursorSpeed > 0))
				{
					gh_nextHitIndex++;
					if (puff_size_modifier == 0)
					{
						puff_size_modifier = 0.05;
					}
					else if (sperm_speed == 0)
					{
						sperm_speed = 0.75;
					}
				}
				
				if (sperm_speed > 0)
				{
					sperm_x += sperm_speed;
				}
				
				space = false;
				drawTaskFour();
				console.log("Task Four Loop");
			}
			
			function taskThree()
			{
				if (taskSetUp[taskIndex] == false)
				{
					setupTaskThree();
				}
				
				tailMoveCounter++;
				if (tailMoveCounter > tailSpeed)
				{
					tailMoveCounter = 0;
					tailImageIndex++;
					if (tailImageIndex == 3)
					{
						tailImageIndex = 1;
					}
				}
				
				if (sperm_speed > 0)
				{
					var newSpermX = sperm_x + Math.cos(sperm_direction * Math.PI / 180) * sperm_speed;
					var newSpermY = sperm_y + Math.sin(sperm_direction * Math.PI / 180) * sperm_speed;
					
					sperm_x = newSpermX;
					sperm_y = newSpermY;
					
					for (let i = 0; i < zpPoints.length; i++)
					{
						if (Math.abs(zpPoints[i].x - sperm_x - sperm_hitbox_x) < 30)
						{
							var x_dif = sperm_x + sperm_hitbox_x - zpPoints[i].x;
							var y_dif = sperm_y + sperm_hitbox_y - zpPoints[i].y;
							var dist = Math.sqrt(x_dif*x_dif + y_dif*y_dif);
							
							if (dist < sperm_hitbox_radius + zpRadius)
							{
								gotEgg = true;
								completeTask();
							}
						}
					}
					
					if ((sperm_x + sperm_hitbox_x > 700) 
						|| (sperm_y + sperm_hitbox_y < 0) 
						|| (sperm_y + sperm_hitbox_y > 480))
					{
						showGame();
					}
				}
				else
				{
					spermAimCounter += spermAimSpeed;
					if (spermAimCounter >= spermAimRange)
					{
						spermAimSpeed = Math.abs(spermAimSpeed) * -1;
					}
					else if (spermAimCounter <= 0)
					{
						spermAimSpeed = Math.abs(spermAimSpeed)
					}
					
					if ((space) && (sperm_speed == 0))
					{
						sperm_direction = spermAimRangeStart - spermAimCounter;
						sperm_speed = 3;
					}
				}
				
				drawTaskThree();
				console.log("Task Three Loop");
			}
			
			function taskTwo()
			{
				if (taskSetUp[taskIndex] == false)
				{
					setupTaskTwo();
				}
				
				//Move points to the left
				for (let i = 0; i < topPoints.length; i++)
				{
					topPoints[i].x -= scrollSpeed;
					bottomPoints[i].x -= scrollSpeed;
				}
				
				if (topPoints[0].x < -distanceBetweenPoints)
				{
					topPoints.shift();
					bottomPoints.shift();
					calciumPoints.shift();
					addPoints(topPoints[topPoints.length-1].x+distanceBetweenPoints);
					if (Math.floor(Math.random()*5) == 0)
					{
						if (calciumCollected < targetCalcium)
						{
							var randCalciumPoint = centerHeight - maxDistFromCenter_calcium + Math.random()*maxDistFromCenter_calcium*2;
							calciumPoints.push(randCalciumPoint);
						}
						else if (!createdEgg)
						{
							calciumPoints.push(-2);
							createdEgg = true;
						}
						else
						{
							calciumPoints.push(-1);
						}
					}
					else
					{
						calciumPoints.push(-1);
					}
				}
				
				for (let i = 0; i < topPoints.length - 1; i++)
				{
					if ((sperm_x + sperm_hitbox_x >= topPoints[i].x) 
					&& (sperm_x + sperm_hitbox_x <= topPoints[i+1].x))
					{
						dangerPointIndex = i;
						i = topPoints.length;
					}
				}
				
				if (dangerPointIndex > 0)
				{
					var x1 = topPoints[dangerPointIndex].x;
					var x2 = topPoints[dangerPointIndex+1].x;
					var y1 = topPoints[dangerPointIndex].y;
					var y2 = topPoints[dangerPointIndex+1].y;
					
					var slope = (y2 - y1) / (x2 - x1);
					var y_intercept = y1 - (slope * x1);
					var dangerY_top = slope * (sperm_x + sperm_hitbox_x) + y_intercept;
					
					x1 = bottomPoints[dangerPointIndex].x;
					x2 = bottomPoints[dangerPointIndex+1].x;
					y1 = bottomPoints[dangerPointIndex].y;
					y2 = bottomPoints[dangerPointIndex+1].y;
					
					slope = (y2 - y1) / (x2 - x1);
					y_intercept = y1 - (slope * x1);
					var dangerY_bottom = slope * (sperm_x + sperm_hitbox_x) + y_intercept;
					
					var sperm_calculatedPosition_y = sperm_y + sperm_hitbox_y;
					if ((sperm_calculatedPosition_y - dangerY_top < sperm_hitbox_radius)
					|| (dangerY_bottom - sperm_calculatedPosition_y < sperm_hitbox_radius))
					{
						showGame();
					}
				}
				
				sperm_speed += sperm_gravity;
				sperm_y += sperm_speed;
				
				if (space)
				{
					sperm_speed = -sperm_jump_speed;
				}
				
				tailMoveCounter++;
				if (tailMoveCounter > tailSpeed)
				{
					tailMoveCounter = 0;
					tailImageIndex++;
					if (tailImageIndex == 3)
					{
						tailImageIndex = 1;
					}
				}
				
				for (let i = 0; i < calciumPoints.length; i++)
				{
					if ((calciumPoints[i] > 0) && (Math.abs(topPoints[i].x - sperm_x - sperm_hitbox_x) < calcium_radius + sperm_hitbox_radius))
					{
						var x1 = topPoints[i].x;
						var x2 = sperm_x + sperm_hitbox_x;
						var y1 = calciumPoints[i];
						var y2 = sperm_y + sperm_hitbox_y;
						var distance = Math.sqrt((x1 - x2)*(x1 - x2) + (y1 - y2) * (y1 - y2));
						if (distance < calcium_radius + sperm_hitbox_radius)
						{
							calciumPoints[i] = -1;
							tailSpeed -= 0.75;
							if (tailSpeed <= 0)
							{
								tailSpeed = 0.5;
							}
							calciumCollected++;
						}
					}
					else if (calciumPoints[i] == -2)
					{
						if (Math.abs(sperm_x + sperm_hitbox_x - topPoints[i].x) < sperm_hitbox_radius + 75)
						{
							gotEgg = true;
							completeTask();
						}
					}
				}
				
				drawTaskTwo();
				console.log("Task Two Loop");
			}

			function taskOne()
			{
				if (taskSetUp[taskIndex] == false)
				{
					setupTaskOne();
				}
				
				//Move points to the left
				for (let i = 0; i < topPoints.length; i++)
				{
					topPoints[i].x -= scrollSpeed;
					bottomPoints[i].x -= scrollSpeed;
				}
				
				if (topPoints[0].x < -distanceBetweenPoints)
				{
					topPoints.shift();
					bottomPoints.shift();
					addPoints(topPoints[topPoints.length-1].x+distanceBetweenPoints);
				}
				
				for (let i = 0; i < topPoints.length - 1; i++)
				{
					if ((sperm_x + sperm_hitbox_x >= topPoints[i].x) 
					&& (sperm_x + sperm_hitbox_x <= topPoints[i+1].x))
					{
						dangerPointIndex = i;
						i = topPoints.length;
					}
				}
				
				if (dangerPointIndex > 0)
				{
					var x1 = topPoints[dangerPointIndex].x;
					var x2 = topPoints[dangerPointIndex+1].x;
					var y1 = topPoints[dangerPointIndex].y;
					var y2 = topPoints[dangerPointIndex+1].y;
					
					var slope = (y2 - y1) / (x2 - x1);
					var y_intercept = y1 - (slope * x1);
					var dangerY_top = slope * (sperm_x + sperm_hitbox_x) + y_intercept;
					
					x1 = bottomPoints[dangerPointIndex].x;
					x2 = bottomPoints[dangerPointIndex+1].x;
					y1 = bottomPoints[dangerPointIndex].y;
					y2 = bottomPoints[dangerPointIndex+1].y;
					
					slope = (y2 - y1) / (x2 - x1);
					y_intercept = y1 - (slope * x1);
					var dangerY_bottom = slope * (sperm_x + sperm_hitbox_x) + y_intercept;
					
					var sperm_calculatedPosition_y = sperm_y + sperm_hitbox_y;
					if ((sperm_calculatedPosition_y - dangerY_top < sperm_hitbox_radius)
					|| (dangerY_bottom - sperm_calculatedPosition_y < sperm_hitbox_radius))
					{
						showGame();
					}
				}
				
				sperm_speed += sperm_gravity;
				sperm_y += sperm_speed;
				
				if (space)
				{
					sperm_speed = -sperm_jump_speed;
				}
				
				tailMoveCounter++;
				if (tailMoveCounter > tailSpeed)
				{
					tailMoveCounter = 0;
					tailImageIndex++;
					if (tailImageIndex == 3)
					{
						tailImageIndex = 1;
					}
				}
				
				drawTaskOne();
				console.log("Task One Loop");
			}
			
			function drawTaskOne()
			{
				ctx.fillStyle = lightPink;
				
				//Background
				ctx.beginPath();
				ctx.fillRect(0, 0, 640, 480);
				
				//Top Walls
				ctx.fillStyle = darkPink;
				ctx.beginPath();
				ctx.moveTo(0, 0);
				for (let i = 0; i < topPoints.length - 1; i++)
				{
					ctx.lineTo(topPoints[i].x, topPoints[i].y);
				}
				ctx.lineTo(640, 0);
				ctx.closePath();
				ctx.fill();
				
				//Bottom Walls
				ctx.beginPath();
				ctx.moveTo(0, 480);
				for (let i = 0; i < bottomPoints.length - 1; i++)
				{
					ctx.lineTo(bottomPoints[i].x, bottomPoints[i].y);
				}
				ctx.lineTo(640, 480);
				ctx.closePath();
				ctx.fill();
				
				//Lines
				ctx.strokeStyle = black;
				ctx.beginPath();
				for (let i = 0; i < topPoints.length - 1; i++)
				{
					ctx.moveTo(topPoints[i].x, topPoints[i].y);
					ctx.lineTo(topPoints[i+1].x, topPoints[i+1].y);
					
					ctx.moveTo(bottomPoints[i].x, bottomPoints[i].y);
					ctx.lineTo(bottomPoints[i+1].x, bottomPoints[i+1].y);
				}
				ctx.stroke();
				
				if (taskIndex < 3)
				{
					if (tailImageIndex == 1)
					{
						ctx.drawImage(sperm_image, sperm_x, sperm_y, sperm_image_width*sperm_scale, sperm_image_height*sperm_scale);
					}
					else
					{
						var upsidedown_sperm_y = sperm_y + sperm_image_height*sperm_scale - sperm_hitbox_y;
						
						ctx.drawImage(sperm2_image, sperm_x, upsidedown_sperm_y, sperm_image_width*sperm_scale, sperm_image_height*sperm_scale);
					}
				}
				
				if ((peaksGenerated > finishPeakIndex) && (taskIndex == 0))
				{
					ctx.textAlign = "center";
					ctx.fillStyle = black;
					ctx.font = "30px Impact";
					ctx.fillText("Task Complete!", 320, 200);
				}
			}
			
			function drawTaskTwo()
			{
				drawTaskOne();
				for (let i = 0; i < calciumPoints.length; i++)
				{
					if (calciumPoints[i] > 0)
					{
						var calcium_x = topPoints[i].x + calcium_radius/2;
						var calcium_y = calciumPoints[i] + calcium_radius/2;
						
						ctx.fillStyle = yellow;
						ctx.beginPath()
						ctx.arc(
							calcium_x,
							calcium_y,
							calcium_radius,
							0, 2*Math.PI
						);
						ctx.fill();
						
						ctx.strokeStyle = brown;
						ctx.beginPath()
						ctx.arc(
							calcium_x,
							calcium_y,
							calcium_radius,
							0, 2*Math.PI
						);
						ctx.stroke();
						
						ctx.textAlign = "center";
						ctx.fillStyle = black;
						ctx.font = "20px Arial";
						ctx.fillText("Ca", calcium_x - 5, calcium_y + 8);
						ctx.font = "14px Arial";
						ctx.fillText("2+", calcium_x + 15, calcium_y + 2);
					}
					else if (calciumPoints[i] == -2)
					{
						ctx.drawImage(egg_image, topPoints[i].x, centerHeight - egg_image_height*egg_scale/2, egg_image_width*egg_scale, egg_image_height*egg_scale);
					}
				}
				
				if (gotEgg)
				{
					ctx.textAlign = "center";
					ctx.fillStyle = black;
					ctx.font = "30px Impact";
					ctx.fillText("Task Complete!", 320, 200);
				}
			}
			
			function drawTaskThree()
			{
				drawTaskOne();
				
				ctx.drawImage(
					egg_zp3_image, 
					egg_x, egg_y, 
					egg_zp3_image_width*egg_zp3_scale, 
					egg_zp3_image_height*egg_zp3_scale
				);
				
				if (sperm_speed == 0)
				{
					var spermAimAngle = spermAimRangeStart - spermAimCounter;
					
					var aim_start_x = Math.cos(spermAimAngle * Math.PI / 180) * aimStartDistance + sperm_x + sperm_hitbox_x;
					var aim_start_y = Math.sin(spermAimAngle * Math.PI / 180) * aimStartDistance + sperm_y + sperm_hitbox_y;
					
					var aim_end_x = Math.cos(spermAimAngle * Math.PI / 180) * aimEndDistance + sperm_x + sperm_hitbox_x;
					var aim_end_y =Math.sin(spermAimAngle * Math.PI / 180) * aimEndDistance + sperm_y + sperm_hitbox_y;
					
					ctx.strokeStyle = darkPink;
					ctx.lineWidth = 5;
					ctx.lineCap = 'round';
					ctx.beginPath();
					ctx.moveTo(aim_start_x, aim_start_y);
					ctx.lineTo(aim_end_x, aim_end_y);
					
					ctx.stroke();
					
					ctx.beginPath();
					ctx.arc(
						sperm_x + sperm_hitbox_x,
						sperm_y + sperm_hitbox_y,
						aimStartDistance,
						(spermAimAngle - 45) * Math.PI / 180,
						(spermAimAngle + 45) * Math.PI / 180
					);
					
					ctx.stroke();
					
					ctx.lineWidth = 1;
				}
				
				if (gotEgg)
				{
					ctx.textAlign = "center";
					ctx.fillStyle = black;
					ctx.font = "30px Impact";
					ctx.fillText("Task Complete!", 320, 200);
				}
			}
			
			function drawTaskFour()
			{
				drawTaskOne();
				
				if (puff_size <= 1.5)
				{
					ctx.drawImage(
						egg_zp3_image, 
						egg_x, egg_y, 
						egg_zp3_image_width*egg_zp3_scale, 
						egg_zp3_image_height*egg_zp3_scale
					);
					
					ctx.drawImage(
						puff_image, 
						egg_x + puff_image_width*egg_zp3_scale/2*(1-puff_size), 
						egg_y + 170 + puff_image_height*egg_zp3_scale/2*(1-puff_size), 
						puff_image_width*egg_zp3_scale*puff_size, 
						puff_image_height*egg_zp3_scale*puff_size
					);
				}
				else
				{
					ctx.drawImage(
						egg_no_zp3_image, 
						egg_x, egg_y, 
						egg_zp3_image_width*egg_zp3_scale, 
						egg_zp3_image_height*egg_zp3_scale
					);
				}
				
				/*ctx.strokeStyle = darkPink;
				ctx.lineWidth = 5;
				ctx.lineCap = 'round';
				
				ctx.beginPath();
				ctx.moveTo(gh_line_X, gh_line_Y1);
				ctx.lineTo(gh_line_X, gh_line_Y2);
				
				for (let i =  0; i < zpPoints.length; i++)
				{
					ctx.moveTo(gh_line_X - 10, gh_line_Y1 + zpPoints[i]);
					ctx.lineTo(gh_line_X + 10, gh_line_Y1 + zpPoints[i]);
				}
				ctx.stroke();
				
				ctx.beginPath();
				ctx.arc(gh_line_X, gh_cursorPosition, gh_radius, 0, Math.PI*2);
				ctx.stroke();
				
				ctx.lineWidth = 1;*/
				
				ctx.textAlign = "center";
				ctx.fillStyle = black;
				ctx.font = "30px Impact";
				ctx.fillText(gh_messageText, 320, 200);
				
				ctx.fillStyle = lightPink;
				ctx.beginPath();
				ctx.moveTo(
					Math.min(sperm_x + sperm_hitbox_x + sperm_hitbox_radius, egg_x + 40),
					sperm_y + sperm_hitbox_y - sperm_hitbox_radius
				);
				ctx.lineTo(
					Math.min(sperm_x + sperm_hitbox_x + sperm_hitbox_radius, egg_x + 40),
					sperm_y + sperm_hitbox_y + sperm_hitbox_radius
				);
				ctx.lineTo(
					sperm_x + sperm_hitbox_radius,
					sperm_y + sperm_hitbox_y + sperm_hitbox_radius + 10
				);
				ctx.lineTo(
					sperm_x + sperm_hitbox_radius,
					sperm_y + sperm_hitbox_y - sperm_hitbox_radius - 10
				);
				ctx.closePath();
				ctx.fill();
				
				if (tailImageIndex == 1)
				{
					ctx.drawImage(sperm_image, sperm_x, sperm_y, sperm_image_width*sperm_scale, sperm_image_height*sperm_scale);
				}
				else
				{
					var upsidedown_sperm_y = sperm_y + sperm_image_height*sperm_scale - sperm_hitbox_y;
					
					ctx.drawImage(sperm2_image, sperm_x, upsidedown_sperm_y, sperm_image_width*sperm_scale, sperm_image_height*sperm_scale);
				}
			}
			
			function drawTaskFive()
			{
				drawTaskOne();
				
				var first_egg_to_draw = egg_image;
				var second_egg_to_draw = egg_image;
				var first_opacity = 1;
				var second_opacity = 0;
				
				if (colorIndex != -1)
				{
					var firstColorIndex = Math.floor(colorIndex/5);
					var secondColorIndex = firstColorIndex + 1;
					var percentDone = colorIndex % 5;
					
					
					second_opacity = percentDone/5;
					first_opacity = 1 - second_opacity;
					
					switch(firstColorIndex)
					{
						case 0:
							first_egg_to_draw = egg_red_image;
							second_egg_to_draw = egg_orange_image;
							break;
						case 1:
							first_egg_to_draw = egg_orange_image;
							second_egg_to_draw = egg_yellow_image;
							break;
						case 2:
							first_egg_to_draw = egg_yellow_image;
							second_egg_to_draw = egg_green_image;
							break;
						case 3:
							first_egg_to_draw = egg_green_image;
							second_egg_to_draw = egg_blue_image;
							break;
						case 4:
							first_egg_to_draw = egg_blue_image;
							second_egg_to_draw = egg_purple_image;
							break;
						case 5:
							first_egg_to_draw = egg_purple_image;
							second_egg_to_draw = egg_sperm_nucleus_image;
							break;
						case 6:
							first_egg_to_draw = egg_sperm_nucleus_image;
							second_egg_to_draw = egg_sperm_nucleus_image;
							break;
					}
				}
				
				ctx.globalAlpha = first_opacity;
				ctx.drawImage(
					first_egg_to_draw, 
					egg_x, egg_y, 
					egg_zp3_image_width*egg_zp3_scale, 
					egg_zp3_image_height*egg_zp3_scale
				);
				
				ctx.globalAlpha = second_opacity;
				ctx.drawImage(
					second_egg_to_draw, 
					egg_x, egg_y, 
					egg_zp3_image_width*egg_zp3_scale, 
					egg_zp3_image_height*egg_zp3_scale
				);
				ctx.globalAlpha = 1;
				
				
				if (sperm_x_offset < sperm_tan_image_width*2/3)
				{
					ctx.fillStyle = lightPink;
					ctx.beginPath();
					ctx.moveTo(
						egg_x + 28,
						sperm_box_y + sperm_hitbox_y - sperm_hitbox_radius
					);
					ctx.lineTo(
						egg_x + 28,
						sperm_box_y + sperm_hitbox_y + sperm_hitbox_radius
					);
					ctx.lineTo(
						Math.min(sperm_box_x + sperm_hitbox_radius, egg_x + 27),
						sperm_box_y + sperm_hitbox_y - 3
					);
					ctx.lineTo(
						Math.min(sperm_box_x + sperm_hitbox_radius, egg_x + 27),
						sperm_box_y + sperm_hitbox_y - 3
					);
					ctx.closePath();
					ctx.fill();
				
					ctx.globalAlpha = 1 - plcz_alpha;
				
					ctx.drawImage(
						sperm_tan_image, //image
						0, 0, //xClip, yClip
						sperm_tan_image_width, sperm_tan_image_height, //xSize, ySize
						211, sperm_y, //xPos, yPos
						sperm_tan_image_width*2/3, sperm_tan_image_height*2/3 //xWidth, yWidth
					);
				}
				
				ctx.globalAlpha = plcz_alpha;
				
				if (colorIndex == -1)
				{
					ctx.drawImage(
						sperm_nucleus_image, 
						egg_x + 40, egg_y + 175, 
						sperm_nucleus_image_width*egg_zp3_scale, 
						sperm_nucleus_image_height*egg_zp3_scale
					);
					
					ctx.drawImage(
						PLCZ_image, 
						egg_x + 60, egg_y + 225, 
						PLCZ_image_width/2, 
						PLCZ_image_height/2
					);
				}
				
				ctx.globalAlpha = 1;
				
				ctx.textAlign = "center";
				ctx.fillStyle = black;
				ctx.font = "30px Impact";
				ctx.fillText(gh_messageText, 320, 200);
			}
			
			function drawTaskSix()
			{
				drawTaskOne();
				
				ctx.drawImage(
					egg_sperm_nucleus_image,
					egg_x, egg_y, 
					egg_zp3_image_width*egg_zp3_scale, 
					egg_zp3_image_height*egg_zp3_scale
				);
				
				for (let i = 0; i < calciumPoints.length; i++)
				{
					if (calciumPoints[i].imageToDraw == 'granule')
					{
						ctx.drawImage(
							granule_image,
							calciumPoints[i].x - granule_image_width*granule_scale/2,
							calciumPoints[i].y - granule_image_height*granule_scale/2,
							granule_image_height/2,
							granule_image_height/2
						);
					}
					else
					{
						ctx.drawImage(
							puff_brown_image,
							calciumPoints[i].x - puff_image_width*egg_zp3_scale/2,
							calciumPoints[i].y - puff_image_height*egg_zp3_scale/2,
							puff_image_width*egg_zp3_scale,
							puff_image_height*egg_zp3_scale
						);
					}
				}
				
				ctx.lineWidth = colorIndex;
				ctx.strokeStyle = black;
				ctx.beginPath();
				ctx.arc(
					egg_x + egg_image_width * egg_zp3_scale + 14,
					egg_y + egg_image_width * egg_zp3_scale + 9,
					egg_image_width * egg_zp3_scale + 11,
					0, Math.PI*2
				);
				ctx.stroke();
				ctx.lineWidth = 1;
				
				ctx.textAlign = "center";
				ctx.fillStyle = black;
				ctx.font = "30px Impact";
				ctx.fillText(gh_messageText, 150, 200);
			}
			
			//from: https://stackoverflow.com/questions/9614109/how-to-calculate-an-angle-from-points
			function angle(cx, cy, ex, ey) {
			  var dy = ey - cy;
			  var dx = ex - cx;
			  var theta = Math.atan2(dy, dx); // range (-PI, PI]
			  theta *= 180 / Math.PI; // rads to degs, range (-180, 180]
			  //if (theta < 0) theta = 360 + theta; // range [0, 360)
			  return theta;
			}
		</script>
	</body>
</html>
